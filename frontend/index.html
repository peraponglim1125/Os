<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Face Attendance System</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f8f9fa; }
    .card { box-shadow: 0 4px 6px rgba(0,0,0,0.08); border: none; }
    .card-header { background-color: #0d6efd; color: #fff; font-weight: 700; }

    /* ‡∏Å‡∏•‡πâ‡∏≠‡∏á */
    .camera-wrap { position: sticky; top: 16px; }
    .camera-container {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      text-align: center;
      min-height: 360px;
    }
    .camera-feed { width: 100%; height: auto; max-height: 640px; object-fit: contain; }
    .live-badge {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255,0,0,0.75); color: #fff; padding: 6px 10px;
      border-radius: 8px; font-size: 12px; animation: blink 2s infinite;
      z-index: 2;
    }
    @keyframes blink { 0%{opacity:1} 50%{opacity:.55} 100%{opacity:1} }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô */
    .btn-checkin { height: 72px; font-size: 22px; font-weight: 800; }
    .scan-status {
      display: flex; align-items: center; justify-content: space-between;
      gap: 12px;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 999px; background: #adb5bd;
      display: inline-block; margin-right: 8px;
    }
    .dot.on { background: #198754; box-shadow: 0 0 0 4px rgba(25,135,84,.18); }

    /* overlay loading */
    #loadingOverlay {
      display: none; position: fixed; inset: 0;
      background: rgba(255,255,255,0.75); z-index: 9999;
      justify-content: center; align-items: center;
    }
  </style>
</head>

<body>
  <div id="loadingOverlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div class="container py-4">
    <h1 class="text-center mb-4">üì∏ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤</h1>

    <!-- =======================
         ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ö (Session)
         ======================= -->
    <div id="sessionPicker" class="row justify-content-center">
      <div class="col-12 col-lg-8">
        <div class="card mb-3">
          <div class="card-header">üóìÔ∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ö / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö</div>
          <div class="card-body">
            <form id="createSessionForm" onsubmit="createSession(event)" class="row g-2 align-items-center">
              <div class="col-12 col-md-9">
                <input id="sessionTitle" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà 3 (09:00-10:00)" required />
              </div>
              <div class="col-12 col-md-3">
                <button class="btn btn-primary w-100">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≤‡∏ö</button>
              </div>
            </form>

            <hr class="my-3" />

            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</div>
              <button onclick="loadSessions()" class="btn btn-sm btn-light">Refresh</button>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0">
                <thead>
                  <tr>
                    <th style="width: 90px;">‡∏Ñ‡∏≤‡∏ö</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡∏ö</th>
                    <th style="width: 160px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                    <th style="width: 140px;"></th>
                  </tr>
                </thead>
                <tbody id="sessionTable"></tbody>
              </table>
            </div>

            <div class="text-muted small mt-2">
              * ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤/‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≤‡∏ö ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≤‡∏ö (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡πÅ‡∏•‡πâ‡∏ß) -->
    <div id="sessionInfo" class="d-none">
      <div class="card mb-3">
        <div class="card-body d-flex flex-wrap gap-2 align-items-center justify-content-between">
          <div>
            <div class="text-muted small">‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
            <div class="h4 mb-0">üéì <span id="sessionInfoTitle">-</span></div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="switchSession()">üîÅ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≤‡∏ö</button>
            <button class="btn btn-outline-danger" onclick="stopAutoScan();" title="‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô">‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô</button>
          </div>
        </div>
      </div>
    </div>

    <div id="attendanceApp" class="row g-3 align-items-start d-none">
      <div class="col-12 col-lg-7">
        <div class="camera-wrap">
          <div class="card mb-3">
            <div class="card-header bg-dark text-white text-center">
              üëÅÔ∏è ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Scan Point)
            </div>

            <div class="card-body p-0 bg-black">
              <div class="camera-container">
                <span class="live-badge">üî¥ LIVE</span>
                <img id="camStream" src="/api/video_feed?mode=preview" class="camera-feed" alt="Camera" />
              </div>
            </div>

            <div class="card-footer bg-white p-3">
              <div class="scan-status mb-2">
                <div>
                  <span id="scanDot" class="dot"></span>
                  <span class="fw-bold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                  <span id="scanStateText" class="text-muted">‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>
                </div>
                <div class="text-muted small">
                  ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô
                </div>
              </div>

              <button id="btnToggleScan" onclick="toggleAutoScan()"
                class="btn btn-success btn-checkin shadow-sm w-100">
                ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Start)
              </button>

              <div id="checkinResult" class="alert mt-3 d-none text-center" role="alert"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-5">
        <div class="d-grid gap-3">
          <div class="card">
            <div class="card-header">üìù ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
            <div class="card-body">
              <form id="enrollForm" onsubmit="enrollStudent(event)">
                <div class="row g-2">
                  <div class="col-4">
                    <input type="text" id="studentId" class="form-control form-control-sm" placeholder="ID" required />
                  </div>
                  <div class="col-8">
                    <input type="text" id="studentName" class="form-control form-control-sm" placeholder="Name" required />
                  </div>
                </div>
                <button type="submit" class="btn btn-sm btn-primary w-100 mt-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
              </form>
              <hr class="my-2">
              <div class="input-group input-group-sm">
                <input type="text" id="faceStudentId" class="form-control" placeholder="ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤" />
                <button onclick="enrollFace()" class="btn btn-outline-primary">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πá‡∏ö</button>
              </div>
              <div id="enrollFaceResult" class="mt-1"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center bg-warning text-dark">
              <span>üïí ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
              <button onclick="loadAttendance()" class="btn btn-sm btn-light py-0">Refresh</button>
            </div>
            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-striped table-sm mb-0 text-center small">
                <thead>
                  <tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th></tr>
                </thead>
                <tbody id="attendanceTable"></tbody>
              </table>
            </div>
          </div>
          
           <div class="card">
             <div class="card-header d-flex justify-content-between align-items-center">
               <span>üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
               <button onclick="loadStudents()" class="btn btn-sm btn-light py-0">Refresh</button>
             </div>
             <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
               <table class="table table-sm mb-0 text-center small">
                 <tbody id="studentTable"></tbody>
               </table>
             </div>
           </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';

    // ========= Sessions =========
    function getSessionIdFromUrl() {
      const sp = new URLSearchParams(window.location.search);
      return sp.get('session_id');
    }

    let CURRENT_SESSION_ID = null;
    let CURRENT_SESSION_TITLE = null;

    function showSessionPicker() {
      document.getElementById('sessionPicker').classList.remove('d-none');
      document.getElementById('sessionInfo').classList.add('d-none');
      document.getElementById('attendanceApp').classList.add('d-none');
    }

    function showAttendanceApp() {
      document.getElementById('sessionPicker').classList.add('d-none');
      document.getElementById('sessionInfo').classList.remove('d-none');
      document.getElementById('attendanceApp').classList.remove('d-none');
    }

    function enterSession(sessionId, title) {
      CURRENT_SESSION_ID = String(sessionId);
      CURRENT_SESSION_TITLE = title || `‡∏Ñ‡∏≤‡∏ö #${sessionId}`;
      localStorage.setItem('last_session_id', CURRENT_SESSION_ID);
      localStorage.setItem('last_session_title', CURRENT_SESSION_TITLE);

      // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡πÉ‡∏´‡πâ‡∏°‡∏µ session_id (‡∏Å‡∏±‡∏ô refresh ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏•‡∏∏‡∏î)
      const newUrl = `/?session_id=${encodeURIComponent(CURRENT_SESSION_ID)}`;
      history.replaceState(null, '', newUrl);

      document.getElementById('sessionInfoTitle').textContent = CURRENT_SESSION_TITLE;
      showAttendanceApp();

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      loadStudents();
      loadAttendance();
      setStreamMode('preview');
    }

    function switchSession() {
      stopAutoScan();
      CURRENT_SESSION_ID = null;
      CURRENT_SESSION_TITLE = null;
      localStorage.removeItem('last_session_id');
      localStorage.removeItem('last_session_title');
      history.replaceState(null, '', '/');
      showSessionPicker();
      loadSessions();
    }

    async function loadSessions() {
      const res = await apiCall('/sessions', 'GET');
      const tbody = document.getElementById('sessionTable');
      tbody.innerHTML = '';
      if (!res || res.error) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-danger">‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≤‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</td></tr>`;
        return;
      }

      if (res.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≤‡∏ö</td></tr>`;
        return;
      }

      res.forEach(s => {
        const created = new Date(s.created_at).toLocaleString('th-TH', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit'
        });

        tbody.innerHTML += `
          <tr>
            <td class="fw-bold">#${s.id}</td>
            <td>${escapeHtml(s.title)}</td>
            <td class="text-muted small">${created}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-success" onclick="enterSession(${s.id}, '${escapeJsString(s.title)}')">‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
            </td>
          </tr>
        `;
      });
    }

    async function createSession(e) {
      e.preventDefault();
      const title = document.getElementById('sessionTitle').value.trim();
      if (!title) return;

      const res = await apiCall('/sessions', 'POST', { title });
      if (res.error) {
        alert(res.error);
        return;
      }
      document.getElementById('createSessionForm').reset();
      // ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏≤‡∏ö‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      enterSession(res.session_id, res.title);
    }

    // helpers ‡∏Å‡∏±‡∏ô XSS ‡πÉ‡∏ô render ‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏á‡πà‡∏≤‡∏¢‡πÜ)
    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (c) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }
    function escapeJsString(s) {
      return String(s || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }

    // ========= Stream mode =========
    function setStreamMode(mode, studentId = "") {
      const img = document.getElementById("camStream");
      const sid = studentId ? `&student_id=${encodeURIComponent(studentId)}` : "";
      img.src = `${API_BASE}/video_feed?mode=${mode}${sid}&t=${Date.now()}`;
    }

    // ========= API Helper =========
    async function apiCall(endpoint, method = 'GET', body = null) {
      // overlay ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏ï‡∏≠‡∏ô auto scan
      if(!endpoint.includes('checkin') && !endpoint.includes('face_status')) {
        document.getElementById('loadingOverlay').style.display = 'flex';
      }
      try {
        const options = { method, headers: { 'Content-Type': 'application/json' } };
        if (body) options.body = JSON.stringify(body);
        const res = await fetch(API_BASE + endpoint, options);
        return await res.json();
      } catch (err) {
        console.error(err);
        return { error: err.message };
      } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    }

    // ========= Continuous Scan Logic =========
    let autoScanOn = false;
    let scanTimer = null;
    let isProcessing = false;
    let resultPause = false;

    async function loopCheckFace() {
      if (!autoScanOn || isProcessing || resultPause) return;

      try {
        const statusRes = await fetch(API_BASE + '/face_status');
        const statusData = await statusRes.json();

        if (statusData.ok) {
           await doCheckin();
        }
      } catch (err) {
        console.log("Loop error:", err);
      }
    }

    async function doCheckin() {
      isProcessing = true;
      
      try {
        setStreamMode("checkin");

        if (!CURRENT_SESSION_ID) {
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
          stopAutoScan();
          return;
        }

        const res = await apiCall('/checkin', 'POST', { session_id: Number(CURRENT_SESSION_ID) });
        showResult(res);

        if (res.status === 'checked_in' || res.status === 'already_checked') {
          resultPause = true; 
          setTimeout(() => {
            clearResult();
            resultPause = false;
            setStreamMode("checkin");
          }, 3000); 
        } else {
          resultPause = true;
          setTimeout(() => {
             clearResult();
             resultPause = false;
             setStreamMode("checkin");
          }, 1500);
        }

      } catch(e) {
        console.error(e);
        isProcessing = false;
      } finally {
        isProcessing = false;
      }
    }

    function showResult(res) {
      const el = document.getElementById('checkinResult');
      el.classList.remove('d-none', 'alert-success', 'alert-warning', 'alert-danger');

      if (res.status === 'checked_in') {
        el.className = 'alert alert-success';
        el.innerHTML = `<h1 class="display-4 fw-bold">‚úÖ ‡∏ú‡πà‡∏≤‡∏ô</h1>
                        <h3>${res.student_id}</h3>
                        <h4>${res.name}</h4>`;
        loadAttendance();
      } else if (res.status === 'already_checked') {
        el.className = 'alert alert-warning';
        el.innerHTML = `<h2 class="fw-bold">‚ö†Ô∏è ‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</h2>
                        <h4>${res.name}</h4>`;
      } else {
        el.className = 'alert alert-danger';
        el.innerHTML = `<h3 class="fw-bold">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                        <p class="mb-0">${res.message ? escapeHtml(res.message) : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'}</p>`;
      }
    }

    function clearResult() {
      const el = document.getElementById('checkinResult');
      el.classList.add('d-none');
    }

    function startAutoScan() {
      autoScanOn = true;
      isProcessing = false;
      resultPause = false;
      updateScanUI();
      setStreamMode("checkin");

      if (scanTimer) clearInterval(scanTimer);
      scanTimer = setInterval(loopCheckFace, 300);
    }

    function stopAutoScan() {
      autoScanOn = false;
      if (scanTimer) clearInterval(scanTimer);
      updateScanUI();
      setStreamMode("preview");
      clearResult();
    }

    function toggleAutoScan() {
      if (autoScanOn) stopAutoScan();
      else startAutoScan();
    }

    function updateScanUI() {
      const btn = document.getElementById("btnToggleScan");
      const dot = document.getElementById("scanDot");
      const txt = document.getElementById("scanStateText");

      if (autoScanOn) {
        btn.className = "btn btn-danger btn-checkin w-100 shadow";
        btn.textContent = "‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏∞‡∏ö‡∏ö (Stop)";
        dot.classList.add("on");
        txt.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...";
        txt.className = "text-success fw-bold";
      } else {
        btn.className = "btn btn-success btn-checkin w-100 shadow";
        btn.textContent = "‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠ (Start)";
        dot.classList.remove("on");
        txt.textContent = "‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà";
        txt.className = "text-muted";
      }
    }

    // ========= Enroll & Data =========
    async function enrollStudent(e) {
      e.preventDefault();
      if(autoScanOn) stopAutoScan();
      
      const id = document.getElementById('studentId').value;
      const name = document.getElementById('studentName').value;
      const res = await apiCall('/enroll', 'POST', { student_id: id, name: name });
      if (res.error) alert(res.error);
      else {
        alert('‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        document.getElementById('enrollForm').reset();
        loadStudents();
      }
    }

    async function enrollFace() {
      if(autoScanOn) stopAutoScan();
      
      const id = document.getElementById('faceStudentId').value;
      if (!id) return alert('‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Å‡πà‡∏≠‡∏ô');

      setStreamMode("enroll", id);
      const res = await apiCall('/enroll_face', 'POST', { student_id: id });
      
      const div = document.getElementById('enrollFaceResult');
      if (res.error) div.innerHTML = `<span class="text-danger">‚ùå ${escapeHtml(res.error)}</span>`;
      else {
        div.innerHTML = `<span class="text-success">‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span>`;
        loadStudents();
      }
      setTimeout(() => setStreamMode("preview"), 2000);
    }

    async function loadStudents() {
      const res = await apiCall('/students', 'GET');
      const tbody = document.getElementById('studentTable');
      tbody.innerHTML = '';
      if(res && res.length) {
        res.forEach(s => {
          tbody.innerHTML += `<tr><td>${s.student_id}</td><td class="text-start">${escapeHtml(s.name)} <span class="badge bg-secondary rounded-pill">${s.face_count}</span></td></tr>`;
        });
      }
    }

    async function loadAttendance() {
      if (!CURRENT_SESSION_ID) return;
      const res = await apiCall(`/attendance?session_id=${encodeURIComponent(CURRENT_SESSION_ID)}`, 'GET');
      const tbody = document.getElementById('attendanceTable');
      tbody.innerHTML = '';
      if(res && res.length) {
        res.forEach(a => {
          const t = new Date(a.checked_at).toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
          tbody.innerHTML += `<tr><td>${t}</td><td>${a.student_id}</td><td class="text-start">${escapeHtml(a.name)}</td></tr>`;
        });
      }
    }

    window.onload = async function() {
      CURRENT_SESSION_ID = getSessionIdFromUrl();

      if (!CURRENT_SESSION_ID) {
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≤‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á -> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        const lastId = localStorage.getItem('last_session_id');
        const lastTitle = localStorage.getItem('last_session_title');
        if (lastId) {
          enterSession(lastId, lastTitle || `‡∏Ñ‡∏≤‡∏ö #${lastId}`);
          return;
        }

        showSessionPicker();
        await loadSessions();
        return;
      }

      // ‡∏°‡∏µ session_id ‡πÉ‡∏ô URL -> ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≤‡∏ö
      try {
        const s = await apiCall(`/sessions/${encodeURIComponent(CURRENT_SESSION_ID)}`, 'GET');
        if (s && !s.error) {
          enterSession(s.id, s.title);
        } else {
          switchSession();
        }
      } catch {
        switchSession();
      }
    }
  </script>
</body>
</html>
